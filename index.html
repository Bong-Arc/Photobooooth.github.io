<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ë§Œì˜ ì¸ìƒë„¤ì»· ë¶€ìŠ¤</title>
    <meta name="robots" content="noindex, nofollow">

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        /* ğŸŸ¢ [ì¶”ê°€] ë¸Œë¼ìš°ì € ë©”ì¸ ìŠ¤í¬ë¡¤ë°” ì™„ì „íˆ ì œê±° */
        html, body {
            height: 100vh; /* ë·°í¬íŠ¸ ë†’ì´ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë„ë¡ ê°•ì œ */
            overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™” (í•µì‹¬) */
            box-sizing: border-box; /* ë†’ì´ ê³„ì‚°ì— íŒ¨ë”© í¬í•¨ */
        }
        
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #222;
            color: white;
            text-align: center;
            margin: 0;
            padding: 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            /* min-heightë¥¼ 100vhë¡œ ê³ ì • */
            height: 100vh; 
            min-height: 100vh;
            box-sizing: border-box;
            width: 100%;
        }
        
        /* --- í”„ë¡œê·¸ë¨ ì œëª© ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        h1#app-title {
            color: #ff6b81;
            transition: opacity 0.2s;
            position: fixed; 
            top: 10px;               
            left: 50%;               
            transform: translateX(-50%); 
            z-index: 200;           
            margin: 0;               
            padding: 0;      
            border-radius: 10px;
            cursor: default; 
            font-size: 20px; 
        }
        h1#app-title.clickable { cursor: pointer; } 
        h1#app-title:hover { opacity: 0.8; }
        
        /* ğŸŸ¢ [ìˆ˜ì •] ì œëª© ë’¤ ì¹´ë©”ë¼ ì•„ì´ì½˜ ìœ„ì¹˜ ì¡°ì • */
        h1#app-title::after {
        content: 'ğŸ“¸'; 
        position: absolute;
        top: -2px; 
        right: -25px;           /* ì œëª© ì˜†ìœ¼ë¡œ ë°°ì¹˜í•˜ì—¬ ì„¸ë¡œ ê³µê°„ ì ˆì•½ */
        font-size: 14px; 
        }
        
        /* ì²« í™”ë©´ ì „ìš© ì¤‘ì•™ ëŒ€í˜• íƒ€ì´í‹€ */
        .start-page-title {
            font-size: 60px; /* í¬ê¸°ë¥¼ ëŒ€í­ í™•ëŒ€ */
            color: #ff6b81;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            animation: fadeInDown 0.8s ease-out;
        }

        /* ì¹´ë©”ë¼ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ìš© */
.start-page-title span {
    display: inline-block;
    animation: bounce 2s infinite;
}

@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-10px);}
    60% {transform: translateY(-5px);}
}

        /* --- ê³µí†µ ì»¨í…Œì´ë„ˆ --- */
        #main-content-container {
            width: 95%;
            max-width: 1000px; /* íƒœë¸”ë¦¿ í™˜ê²½ ê³ ë ¤ */
            padding: 30px 10px 10px 10px; 
            
            /* ìŠ¤í¬ë¡¤ ê´€ë ¨ ìœ ì§€ */
            max-height: 100vh; 
            overflow-y: auto; 
            box-sizing: border-box; 
        }

        /* ğŸŸ¢ [ì¶”ê°€] ë‹¨ê³„ ì œëª©(ì˜ˆ: 'í”„ë ˆì„ ì„ íƒ')ì˜ ìƒë‹¨ ë§ˆì§„ ì œê±° */
        #main-content-container h2 {
            margin-top: 0; 
            margin-bottom: 20px; /* ì œëª© ì•„ë˜ìª½ ì—¬ë°±ì€ ìœ ì§€ */
            font-size: 24px;
        }
        
        /* ğŸŸ¢ [ì¶”ê°€] 1:1.6 ë¹„ìœ¨ì˜ ë‚´ë¶€ ì˜ì—­ ìƒì„± (í•µì‹¬) */
        #main-content-container::before {
            content: '';
            display: block;
            /* 160% = (1.6 / 1) * 100%. ì¦‰, ë†’ì´ë¥¼ ë„ˆë¹„ì˜ 160%ë¡œ ì„¤ì • */
            padding-top: 160%; 
        }

        /* ğŸŸ¢ [ì¶”ê°€] ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ì‹¤ì œ ë‚´ìš©ë¬¼(ìì‹ ìš”ì†Œ)ì„ ë¹„ìœ¨ ì•ˆì— ê³ ì • */
        #main-content-container > div {
            position: absolute;
            top: 100px; /* padding-topê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ì—¬ ì œëª© ì•„ë˜ë¶€í„° ì‹œì‘ */
            left: 0;
            width: 100%;
            height: calc(100% - 100px); /* ì „ì²´ ë†’ì´ì—ì„œ padding-topë§Œí¼ ì œì™¸ */
            overflow: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
        }

        /* --- ì¹´ë©”ë¼ ì˜ì—­ (2ë‹¨ê³„) --- */
        #video-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: #000;
            display: none;
            z-index: 99; 
        }
        #video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            /* 1.2ë°° í™•ëŒ€ ë° ê¸°ì¡´ ì¢Œìš° ë°˜ì „ ìœ ì§€ */
            transform: scale(1.2) scaleX(-1); 
            display: block;
        }

        /* ì´¬ì˜ ì¤‘ UI */
        #timer {
            top: 30%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px; 
            font-weight: bold;
            color: #FF4649; 
            text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
            display: none;
            position: absolute;
            z-index: 100;
        }
        #shot-count {
            bottom: 150px; 
            left: 50%;    
            transform: translateX(-50%); 
            background: #2c2c2c;
            color: white;
            padding: 10px 15px;
            border-radius: 30px;
            font-size: 1.8em;
            display: none;
            position: absolute;
            z-index: 100;
        }

       /*ì¹´ë©”ë¼ ì´¬ì˜ì‹œì‘ ë²„íŠ¼*/
        #controls {
            width: 100%;
            bottom: 15%; 
            
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            
            justify-content: center; 
            
            display: none; 
            position: absolute;
            z-index: 100;
        }
        
        /*ì´¬ì˜ì‹œì‘ ìœ„ì˜ ë¬¸êµ¬*/
        #controls .msg { 
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        /* ğŸŸ¢ [ìˆ˜ì •] ì¹´ë©”ë¼ í™”ë©´ì˜ í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .home-button-camera {
        /* ë‹¤ìŒ ë²„íŠ¼ì˜ í¬ê¸°(70px x 70px)ì— ë§ì¶¥ë‹ˆë‹¤. */
            width: 70px; 
            height: 70px;
            border-radius: 50%; /* ì›í˜• ìœ ì§€ */
            font-size: 28px; /* ì•„ì´ì½˜ í¬ê¸° í™•ëŒ€ */
            padding: 0;
            
            /* ğŸš¨ [ì¶”ê°€] ë²„íŠ¼ ë°°ê²½ìƒ‰ì„ ì›í•˜ëŠ” íšŒìƒ‰(#6c757d)ìœ¼ë¡œ ì§€ì •í•˜ì—¬ í•‘í¬ìƒ‰ì„ ë®ì–´ì”ë‹ˆë‹¤. */
            background-color: #6c757d;
    
            /* ìœ„ì¹˜ ì§€ì • */
            position: absolute; 
            top: 35px; 
            left: 20px; 
            z-index: 101;
        }

        /* ğŸŸ¢ [ì¶”ê°€] ì¹´ë©”ë¼ í™ˆ ë²„íŠ¼ ì „ìš© í˜¸ë²„ íš¨ê³¼ */
        .home-button-camera:hover {
            background-color: #5a6268;
            transform: scale(1.1); /* í¬ê¸° ì»¤ì§€ëŠ” íš¨ê³¼ ìœ ì§€ */
        }
        
        /* --- ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ --- */
        button {
            background: #ff6b81;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: 0.2s;
            min-width: 80px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
        }
        button:hover { background: #ff4757; transform: scale(1.05); }
        button:disabled { background: #555; cursor: not-allowed; }

        
        /* --- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (2ë²ˆ ì´ë¯¸ì§€ ë””ìì¸ ë°˜ì˜) --- */
        .save-button {
            background: #00d2d3; 
            font-size: 20px;
            padding: 15px 40px;
            margin-bottom: 20px;
        }
        .save-button:hover {
            background: #00a0a1;
        }
        .home-button-pink, .nav-arrow-button {
            padding: 15px;
            width: 70px; 
            height: 70px;
            border-radius: 50%;
            font-size: 24px;
        }
        .home-button-pink {
            background: #ff6b81; 
        }
        .home-button-pink:hover {
            background: #ff4757; 
        }
        .nav-arrow-button {
            background: #6c757d; 
        }
        .nav-arrow-button:hover {
            background: #5a6268;
        }
        .result-nav-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        /* ğŸŸ¢ [ì¶”ê°€] ê³µìœ  ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .save-button-wrapper {
            display: flex; /* Flexbox ì‚¬ìš© */
            justify-content: center; /* ìì‹ ìš”ì†Œ(ë²„íŠ¼)ë¥¼ ì¤‘ì•™ìœ¼ë¡œ ì •ë ¬ */
            width: 100%;
            margin-top: 10px; /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ (í•„ìš” ì‹œ) */
        }

        /* ğŸŸ¢ [ìˆ˜ì •] ë‹¤ìŒ ë²„íŠ¼ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        #next-to-edit-btn {
            background: #6c757d; /* íšŒìƒ‰ (ë¹„í™œì„±í™” ê¸°ë³¸ìƒ‰) */
            transition: background 0.2s, transform 0.2s;
        }

        /* ğŸŸ¢ [ìˆ˜ì •] 4ì¥ ì„ íƒ ì™„ë£Œ ì‹œ í™œì„±í™”ë˜ëŠ” í•‘í¬ìƒ‰ ìŠ¤íƒ€ì¼ */
        #next-to-edit-btn.active {
            background: #ff6b81; /* í•‘í¬ìƒ‰ */
        }
        #next-to-edit-btn.active:hover {
            background: #ff4757; 
            transform: scale(1.05);
        }

        /* ğŸŸ¢ [ìˆ˜ì •] ë¹„í™œì„±í™” ìƒíƒœì¼ ë•Œ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë°©ì§€ */
        #next-to-edit-btn:disabled, #next-to-edit-btn:disabled:hover {
        background: #6c757d; 
            cursor: not-allowed;
            transform: none;
        }

       /* --- í”„ë¦¬ë·° ìº”ë²„ìŠ¤ ê³µí†µ ìŠ¤íƒ€ì¼ (í¬ê¸° ì œì™¸) --- */
        /* ğŸŸ¢ [ë¶„ë¦¬] ëª¨ë“  ìº”ë²„ìŠ¤ê°€ ê³µìœ í•˜ëŠ” ìŠ¤íƒ€ì¼ë§Œ ë‚¨ê¹ë‹ˆë‹¤. */
        #preview-canvas, #preview-canvas-edit { 
            margin: 20px auto 10px auto; /* ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ autoë¡œ ì„¤ì • */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background-color: white; /* ìº”ë²„ìŠ¤ ë°°ê²½ìƒ‰ */
            display: block; 
            object-fit: contain; 
        }
        
        /* ë§ˆì§€ë§‰ í˜ì´ì§€ í”„ë¦¬ë·° í•˜ë‹¨ ì—¬ë°± */
        #final-canvas, #final-image-for-save { 
            margin: 20px auto 70px auto; /* ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ autoë¡œ ì„¤ì • */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background-color: white; /* ìº”ë²„ìŠ¤ ë°°ê²½ìƒ‰ */
            display: block; 
            object-fit: contain; 
        }
        /* 1. ğŸŸ¢ [ì‚¬ì§„ ì„ íƒ ë‹¨ê³„] í”„ë¦¬ë·° í¬ê¸° */
        #preview-canvas { 
            width: 380px; 
            height: 562px; /* 380 * 1.48 ë¹„ìœ¨ */
        }

        /* 2. ğŸŸ¢ [í”„ë ˆì„ ì„ íƒ ë‹¨ê³„] í”„ë¦¬ë·° í¬ê¸°  */
        #preview-canvas-edit {
            width: 450px; 
            height: 666px; 
        }

        /* 3. ğŸŸ¢ [ì™„ì„± í˜ì´ì§€] í”„ë¦¬ë·° í¬ê¸°  */
        #final-canvas, #final-image-for-save {
            width: 450px; 
            height: 666px; 
        }
        #preview-canvas-edit { margin-top: 0; }
        
        /* --- ê°¤ëŸ¬ë¦¬ (3ë‹¨ê³„) --- */
        #gallery-wrapper {
            background: #333; 
            width: 95%;
            margin: 15px auto 0 auto;
            overflow-x: auto; 
            white-space: nowrap; 
            padding: 10px 10px;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
        }
        
        /* ğŸŸ¢ [ìˆ˜ì •] ê°¤ëŸ¬ë¦¬ ì‚¬ì§„ í¬ê¸° í™•ëŒ€ ë° ë¹„ìœ¨ ìœ ì§€ */
        .photo-item {
            display: inline-block;
            width: 180px; /* â¬…ï¸ ë„ˆë¹„ë¥¼ 150pxë¡œ í™•ëŒ€ */
            height: auto; /* â¬…ï¸ ë†’ì´ë¥¼ autoë¡œ ë³€ê²½í•˜ì—¬ ë‚´ìš©ë¬¼(ì´ë¯¸ì§€)ì— ë§ì¶¤ */
            min-height: 90px;
            margin: 0 5px;
            border: 3px solid transparent; 
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            vertical-align: top; 
            box-sizing: border-box;
            background-color: black;
            cursor: pointer;
        }
        .photo-item img {
            width: 100%;
            height: 100%;
            /* ğŸŸ¢ [ìˆ˜ì •] ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê³  ì „ì²´ í‘œì‹œë˜ë„ë¡ ë³€ê²½ */
            object-fit: contain;
            display: block;
        }
        .photo-item.selected { 
            border-color: #00d2d3; 
        }
        .photo-item.selected::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4); 
            pointer-events: none; 
            z-index: 5; 
        }
        .photo-item .badge {
            position: absolute;
            top: 5px; right: 5px; /* ìœ„ì¹˜ ì¡°ì • */
            background: #00d2d3; 
            color: black; 
            border-radius: 50%;
            width: 25px; height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            display: none;
            z-index: 10;
        }

        /* --- í”„ë ˆì„ ì„ íƒ UI (4ë‹¨ê³„) --- */
        #frame-options-list {
            background: #333; 
            width: 95%;
            margin: 15px auto 0 auto;
            overflow-x: auto; 
            white-space: nowrap; 
            padding: 10px 10px;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
        }

        .frame-option {
            display: inline-block;
            width: 80px; 
            height: 120px; 
            margin: 0 5px;
            border: 3px solid transparent;
            border-radius: 5px;
            background-size: cover;
            background-position: center;
            box-sizing: border-box;
            position: relative;
            vertical-align: top;
            flex-shrink: 0;
            background-color: white;
            cursor: pointer;
        }
        .frame-option.selected { 
            border-color: #00d2d3; 
        }

        .frame-option:not(.selected)::before {
             /* ì„ íƒë˜ì§€ ì•Šì€ í”„ë ˆì„ì—ëŠ” ì–´ë‘¡ê²Œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ */
             content: none;
        }
        

/* --- ì‹œì‘ í™”ë©´ (1ë‹¨ê³„) - ê´€ë¦¬ì ëª¨ë“œ ë° í•˜ë‹¨ ê³ ì • UI ë°˜ì˜ --- */
        #step-start {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: relative;
            box-sizing: border-box;
            /* ë°°ê²½ í´ë¦­ ì‹œ ê´€ë¦¬ì ëª¨ë“œ ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì—¬ë°± í™•ë³´ */
            padding-bottom: 250px; 
            justify-content: center; /* ë¡œê³  ë“±ì„ ì¤‘ì•™ì— ë°°ì¹˜í•˜ê³  ì‹¶ì„ ë•Œ */
        }

        /* ğŸŸ¢ í•˜ë‹¨ ê³ ì • ì˜ì—­ (ë²„íŠ¼ + ê´€ë¦¬ì ë°•ìŠ¤ë¥¼ í¬í•¨) */
        .bottom-fixed-area {
            position: absolute;
            bottom: 50px; /* í™”ë©´ ìµœí•˜ë‹¨ì—ì„œ ë„ì›€ */
            width: 95%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* ë°•ìŠ¤ì™€ ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²© */
            z-index: 100;
        }

        /* ğŸŸ¢ ê´€ë¦¬ì íŒ¨ë„ (ë²„íŠ¼ ë°”ë¡œ ìœ„ì— ë°°ì¹˜) */
        /* ğŸŸ¢ ê´€ë¦¬ì íŒ¨ë„ ìˆ˜ì •: ë²„íŠ¼ ìœ„ ìœ„ì¹˜ ê³ ì • ë° ë„ˆë¹„ í™•ì¥ */
        #admin-panel {
            display: none; 
           /* 95%ë¡œ ì„¤ì •í•˜ë˜, ìµœëŒ€ì¹˜ë¥¼ 1000px ì´ìƒìœ¼ë¡œ ë„‰ë„‰íˆ ì¡ìŠµë‹ˆë‹¤ */
            width: 90vw; 
            max-width: 1000px; 
            background: rgba(40, 40, 40, 0.95);
            padding: 20px;
            border-radius: 20px;
            border: 1px dashed #ff6b81;
            box-sizing: border-box;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);

           /* ìœ„ì¹˜ ì„¤ì • */
           position: absolute;
           bottom: 110%;       /* ë²„íŠ¼ê³¼ ì•½ê°„ ë” ë„ì›€ */
           left: 50%;          
           transform: translateX(-50%); 
           z-index: 100;
        }

        #start-frame-gallery {
          display: flex;
          gap: 15px; /* í”„ë ˆì„ ì‚¬ì´ ê°„ê²© */
          flex-shrink: 0; /* ë‚´ìš©ì´ ì¤„ì–´ë“¤ì§€ ì•Šê²Œ */
        }

        /* ğŸŸ¢ í”„ë ˆì„ ëª©ë¡ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        #start-frame-gallery-wrapper {
            display: flex;
            align-items: flex-start; /* ìƒë‹¨ ê¸°ì¤€ ì •ë ¬ */
            justify-content: flex-start; /* ğŸŸ¢ ì™¼ìª½ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ì •ë ¬ */
            gap: 15px;
            overflow-x: auto; 
            padding: 15px 5px;
            width: 100%;
            -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            scrollbar-width: thin;
    }

        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (ì„ íƒ ì‚¬í•­) */
        #start-frame-gallery-wrapper::-webkit-scrollbar {
            height: 6px;
        }
        #start-frame-gallery-wrapper::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }

        #start-frame-gallery {
            display: flex;
            gap: 15px;
        }

        .start-frame-item {
            position: relative;
            width: 80px; 
            height: 120px; 
            flex-shrink: 0; 
            border: 3px solid transparent; 
            border-radius: 5px;
            overflow: hidden;
            box-sizing: border-box;
            background-color: white; 
            cursor: pointer;
        }
        .start-frame-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .start-frame-item.selected {
            border-color: #00d2d3; 
        }
        .start-frame-item .remove-btn {
            position: absolute;
            top: -2px; right: -2px; 
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px; height: 22px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* ğŸŸ¢ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .start-buttons-container {
            position: absolute;
            bottom: 50px; /* í™”ë©´ í•˜ë‹¨ ì—¬ë°± */
            width: 90%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column; /* ì„¸ë¡œë¡œ ë°°ì¹˜ */
            gap: 15px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
            z-index: 20;
        }

        /* ê´€ë¦¬ì ëª¨ë“œ ë²„íŠ¼ (ì´¬ì˜í•˜ê¸° ìœ„ìª½ ë°°ì¹˜ìš©) */
        #admin-toggle-btn {
            background: #444;
            font-size: 14px;
            padding: 12px;
            border-radius: 30px;
            opacity: 0.8;
            width: fit-content;
            align-self: center; /* ì¤‘ì•™ ì •ë ¬ */
            min-width: 120px;
        }

        #start-shoot-btn {
            background: #ff6b81;
            padding: 20px;
            font-size: 22px;
            border-radius: 40px;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .frame-add-btn {
            flex-shrink: 0; 
            margin-top: 0; /* í”„ë ˆì„ê³¼ ë†’ì´ ë§ì¶¤ */
            cursor: pointer;
            background: none;
            border: 2px dashed #777;
            color: #ddd;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px; height: 120px;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .start-frame-item .frame-name {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.6em;
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* í”„ë ˆì„ ì¶”ê°€ ë²„íŠ¼ */
        .frame-add-btn {
            background: none;
            border: 2px dashed #777; 
            color: #ddd;
            font-size: 0.8em;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: 80px; 
            height: 120px; 
            flex-shrink: 0;
            transition: background 0.2s;
            line-height: 1.3;
            box-sizing: border-box;
        }
        .frame-add-btn:hover { background: rgba(100, 100, 100, 0.2); }
        .frame-add-btn span { font-size: 1.5em; margin-bottom: 5px; }

        /* ğŸŸ¢ ì´¬ì˜í•˜ê¸° ë²„íŠ¼ í•˜ë‹¨ ê³ ì • */
        .start-buttons-container {
            position: absolute;
            bottom: 15%;  /* í™”ë©´ í•˜ë‹¨ ì—¬ë°± */
            width: 90%;
            max-width: 400px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }
        
        #start-shoot-btn {
            background: #ff6b81; 
            padding: 20px;
            font-size: 22px;
            border-radius: 40px;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #start-shoot-btn:hover { background: #ff4757; transform: scale(1.02); }
        #start-shoot-btn:disabled { background: #555; transform: none; box-shadow: none; }
        
        /* --- 5ë‹¨ê³„ ì™„ì„± í™”ë©´ --- */
        #result-container h2 {
            color: #00d2d3; 
            font-size: 24px;
        }
        
        /* 3ë‹¨ê³„ 'ì‚¬ì§„ ì„ íƒ' í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .selection-status {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
            color: #00d2d3; /* ìƒ‰ìƒ ë³€ê²½ */
        }

        
        /* --- ğŸŸ¢ [ìƒˆ ì½”ë“œ] ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ --- */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>
    <div id="loading-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #222; /* ë°°ê²½ìƒ‰ì€ ì•± ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ */
        color: #ff6b81;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000; /* ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œë³´ë‹¤ ìœ„ì— í‘œì‹œ */
        font-size: 1.5em;
        font-weight: bold;
    ">
        <div class="spinner" style="
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #ff6b81;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        "></div>
        ì‚¬ì§„ ë¶€ìŠ¤ ì¤€ë¹„ ì¤‘...
    </div>

    <h1 id="app-title">ì¸ìƒë„¤ì»·</h1> 

    
<div id="step-start">
    <div class="start-page-title">
        ì¸ìƒë„¤ì»· <span>ğŸ“¸</span>
    </div>

    <div class="start-buttons-container">
        </div>
</div>
        <div class="start-buttons-container">
        
        <div id="admin-panel">
            <h3 style="margin-top: 0; color: #00d2d3; font-size: 18px;">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ</h3>
            <div id="start-frame-gallery-wrapper">
                <div id="start-frame-gallery"></div>
                <label for="frame-upload" class="frame-add-btn" id="add-btn-label">
                    <span>+</span> í”„ë ˆì„ ì¶”ê°€
                </label>
                <input type="file" id="frame-upload" accept="image/png, image/jpeg" multiple style="display: none;">
            </div>

                <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px; text-align: center;">
                <label style="color: #00d2d3; font-weight: bold; font-size: 18px;">ğŸ“¤ ê³µìœ  ë©”ì‹œì§€ ì„¤ì •</label>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="text" id="share-msg-input" 
                        placeholder="ê³µìœ  ì‹œ í‘œì‹œë  ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”." 
                        style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #555; background: #222; color: white;">
                    <button onclick="saveShareMessage()" 
                            style="background: #00d2d3; padding: 10px 15px; font-size: 14px; min-width: 60px;">ì €ì¥</button>
                </div>
            </div>
        </div>

           <button id="admin-toggle-btn" onclick="toggleAdminMode()">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ</button>
            <button id="start-shoot-btn" disabled>ğŸ“¸ ì´¬ì˜í•˜ê¸°</button>
        </div>
    </div>
    
    <div id="video-container">
        <button class="action-button-base home-button-camera" onclick="stopCameraAndGoHome()">
            â¬…ï¸
        </button>

        <video id="video" autoplay playsinline muted></video>
        <div id="timer"></div>
        <div id="shot-count"></div>
        
        <div id="controls" style="display:none;">
            <p class="msg" id="shoot-msg">ì´ 6ì¥ì„ ì´¬ì˜í•©ë‹ˆë‹¤!</p> 
            <button id="shoot-btn">ì´¬ì˜ ì‹œì‘</button>
        </div>
    </div>
    
    
    <div class="container" id="main-content-container" style="display:none;">

        
        <div id="step-select" style="display:none;">
            <h2 class="selection-status" id="selection-status-text">ğŸ“¸ ì‚¬ì§„ ì„ íƒ (0/4)</h2>
            <canvas id="preview-canvas"></canvas> 

            <div id="gallery-wrapper">
                <div id="gallery"></div>
            </div>
            
            <div class="result-nav-container" style="margin-top: 20px;">
                <button id="next-to-edit-btn" class="nav-arrow-button" onclick="goToEditStep()" disabled>â¡ï¸</button>
            </div>
        </div>
        
        
        <div id="step-edit" style="display:none;">
            <h2 style="color: #00d2d3;">ğŸ–¼ï¸ í”„ë ˆì„ ì„ íƒ</h2>
            
            <canvas id="preview-canvas-edit"></canvas> 
            <div class="edit-option-list" id="frame-options-list">
            </div>
            
            <div class="result-nav-container">
                <button class="nav-arrow-button" onclick="goToSelectStep()">â¬…ï¸</button>
                <button id="make-final-btn" class="home-button-pink" onclick="createComposite()">â¡ï¸</button>
            </div>
        </div>

        
        <div id="result-container" style="display:none;">
            <h2>âœ¨ ì™„ì„± âœ¨</h2>
    
            <canvas id="final-canvas"></canvas> 
            <img id="final-image-for-save" style="display: none;"/> 
    
            <div class="save-button-wrapper"> 
                <button id="save-and-stay-btn" class="save-button" onclick="downloadAndShare()">
                    <span style="font-size: 1.2em; margin-right: 5px;">ğŸ“¤</span> ì €ì¥/ê³µìœ í•˜ê¸°
                </button>
            </div>
    
            <div class="result-nav-container">
            </div>

            <div class="result-nav-container">
                <button class="nav-arrow-button" onclick="goToEditStep()">
                    <span style="font-size: 1.2em;">â¬…ï¸</span>
                </button>
                <button class="home-button-pink" onclick="goToHome()">
                    <span style="font-size: 1.2em;">ğŸ </span>
                </button>
            </div>
        </div>
    </div>
    
    <script>
// ìƒë‹¨ ë³€ìˆ˜ ì„ ì–¸ë¶€
let videoStream;
const video = document.getElementById('video');
const photos = [];
let selectedIndices = [];
let currentShot = 0;
let uploadedFrames = [];
let selectedFrameId = null;
let finalImageDataURL = null;
// ğŸŸ¢ [ì¶”ê°€] ê³µìœ  ë©”ì‹œì§€ ê¸°ë³¸ê°’ ë³€ìˆ˜
let shareMessage = "ë‚˜ë§Œì˜ ì¸ìƒë„¤ì»· ì‚¬ì§„ì…ë‹ˆë‹¤.";
 
        // ------------------------------------
        // ğŸŸ¢ [ìƒˆ í•¨ìˆ˜] Data URLì„ Blob ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        // ------------------------------------
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }
        
// DOMContentLoaded ë‚´ë¶€ ë¡œì§ ìˆ˜ì •
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        setupCanvases(); 
        loadFrames(); 
        loadShareMessage(); // ğŸŸ¢ [ì¶”ê°€] ì €ì¥ëœ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        renderStartFrameGallery(); 
        
        document.getElementById('main-content-container').style.display = 'none'; 
        document.getElementById('step-start').style.display = 'flex'; 
        setHomeButtonActive(false); 
        
        document.getElementById('start-shoot-btn').onclick = startCamera; 
        document.getElementById('loading-screen').style.display = 'none'; 
    }, 1000);
});

// ğŸŸ¢ [ì¶”ê°€] ë©”ì‹œì§€ ë¡œë“œ/ì €ì¥ í•¨ìˆ˜
function loadShareMessage() {
    const savedMsg = localStorage.getItem('customShareMessage');
    if (savedMsg) {
        shareMessage = savedMsg;
    }
    document.getElementById('share-msg-input').value = shareMessage;
}

function saveShareMessage() {
    const newMsg = document.getElementById('share-msg-input').value;
    shareMessage = newMsg;
    localStorage.setItem('customShareMessage', newMsg);
    alert("ê³µìœ  ë¬¸êµ¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
}

        // ìº”ë²„ìŠ¤ ê¸°ë³¸ ì„¤ì • (ëª¨ë“  ìº”ë²„ìŠ¤ì— ì ìš©)
        function setupCanvases() {
            const canvases = ['preview-canvas', 'preview-canvas-edit', 'final-canvas'];
            canvases.forEach(id => {
                const canvas = document.getElementById(id);
                // ğŸŸ¢ [ìˆ˜ì •] ìƒˆë¡œìš´ ë¬¼ë¦¬ì  ë¹„ìœ¨(100:148)ì— ë§ì¶˜ ê³ í•´ìƒë„ ì‘ì—… ì˜ì—­ (3000x4440)ìœ¼ë¡œ ë³€ê²½
                canvas.width = 3000; 
                canvas.height = 4440; // 3000 * 1.48 = 4440
            });
        }

        // --- ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ ---
        function goToHome() {
            // ğŸš¨ [ì£¼ì˜] í™ˆ ë³µê·€ ì „ ì‚¬ìš©ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ ë„ìš°ê¸°
            const confirmed = confirm("ì´¬ì˜ëœ ì¸ìƒ4ì»·ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.");
            
            if (confirmed) {
                location.reload(); // ë™ì˜í•˜ë©´ ì•±ì„ ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ë¡œë“œ
            } 
            // ì·¨ì†Œí•˜ë©´ í˜„ì¬ í˜ì´ì§€ì— ë‚¨ì•„ìˆê²Œ ë©ë‹ˆë‹¤.
        }

        // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
        function toggleAdminMode() {
            const adminPanel = document.getElementById('admin-panel');
            const toggleBtn = document.getElementById('admin-toggle-btn');
            
            if (adminPanel.style.display === 'none' || adminPanel.style.display === '') {
                adminPanel.style.display = 'block';
                toggleBtn.innerHTML = 'âŒ ê´€ë¦¬ì ëª¨ë“œ ë‹«ê¸°';
                toggleBtn.style.background = '#ff4757';
            } else {
                adminPanel.style.display = 'none';
                toggleBtn.innerHTML = 'âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ';
                toggleBtn.style.background = '#444';
            }
        }

        // ğŸŸ¢ [ì¶”ê°€] ì¹´ë©”ë¼ ë‹¨ê³„ì—ì„œ í™ˆìœ¼ë¡œ ëŒì•„ê°€ëŠ” í•¨ìˆ˜
        function stopCameraAndGoHome() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            goToHome();
        }

        function setHomeButtonActive(isActive) {
            const titleEl = document.getElementById('app-title');
            if (isActive) {
                titleEl.classList.add('clickable');
                titleEl.setAttribute('onclick', 'goToHome()');
                titleEl.style.display = 'block'; // í˜¹ì‹œ ìˆ¨ê²¨ì ¸ ìˆë‹¤ë©´ ë‹¤ì‹œ í‘œì‹œ
            } else {
                titleEl.classList.remove('clickable');
                titleEl.removeAttribute('onclick');
                titleEl.style.display = 'block'; // ì²« í™”ë©´ì—ëŠ” í•­ìƒ í‘œì‹œ
            }
        }
        
        // 3ë‹¨ê³„ ì‚¬ì§„ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
        function goToSelectStep() {
            document.getElementById('main-content-container').style.display = 'block'; 

            document.getElementById('step-edit').style.display = 'none';
            document.getElementById('result-container').style.display = 'none'; 
            document.getElementById('step-select').style.display = 'block';
            document.getElementById('gallery-wrapper').style.display = 'block'; 
            
            updateSelectionStatus();
            updateBadges(); 
            // 4ì¥ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
            const nextBtn = document.getElementById('next-to-edit-btn');
            const isFourSelected = (selectedIndices.length === 4);
            nextBtn.disabled = !isFourSelected;
            if (isFourSelected) {
                nextBtn.classList.add('active');
            } else {
                nextBtn.classList.remove('active');
            }

            updatePreview('preview-canvas'); 
            
            setHomeButtonActive(true); 
        }

        // 4ë‹¨ê³„ í”„ë ˆì„ í¸ì§‘ í™”ë©´ìœ¼ë¡œ ì´ë™
        function goToEditStep() {
            if (selectedIndices.length !== 4) {
                 alert("ì‚¬ì§„ 4ì¥ì„ ëª¨ë‘ ì„ íƒí•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                 return;
            }
            if (uploadedFrames.length === 0) {
                 alert("í”„ë ˆì„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
                 return;
            }
            
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('step-select').style.display = 'none';
            document.getElementById('step-edit').style.display = 'block';
            
            renderFrameOptions(); 
            updatePreview('preview-canvas-edit');

            setHomeButtonActive(true); 
        }

        // 5ë‹¨ê³„ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™ (ìµœì¢… í•©ì„± ì´ë¯¸ì§€ ìƒì„± ë° í‘œì‹œ)
        async function createComposite() {
           document.getElementById('step-edit').style.display = 'none';
           document.getElementById('result-container').style.display = 'block';

          const canvas = document.getElementById('final-canvas');
          await drawComposite('final-canvas'); 

          // Data URLë§Œ ìƒì„±í•©ë‹ˆë‹¤.
          finalImageDataURL = canvas.toDataURL('image/png'); 

           // 1. ìº”ë²„ìŠ¤ ìˆ¨ê¸°ê³  <img> íƒœê·¸ì— ì´ë¯¸ì§€ ë°ì´í„° í• ë‹¹ (ê¾¹ ëˆŒëŸ¬ ì €ì¥ í™œì„±í™”)
           const imgEl = document.getElementById('final-image-for-save');
           imgEl.src = finalImageDataURL; 
           imgEl.style.display = 'block'; 
          canvas.style.display = 'none'; // ìº”ë²„ìŠ¤ ìˆ¨ê¹€

          // ğŸŸ¢ [ìˆ˜ì •] QR ì½”ë“œ ê´€ë ¨ ì½”ë“œë¥¼ ì‚­ì œí•˜ê³ , 'ê³µìœ /ì „ì†¡í•˜ê¸°' ë²„íŠ¼ì„ ë°”ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
          document.getElementById('save-and-stay-btn').style.display = 'block'; 

          setHomeButtonActive(true); 
        }
        

        // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë° í”„ë ˆì„ ê´€ë¦¬ ---
        function loadFrames() {
            const savedFrames = localStorage.getItem('customFrames');
            if (savedFrames) {
                try {
                    uploadedFrames = JSON.parse(savedFrames).map(f => ({ ...f, id: String(f.id) }));
                } catch (e) {
                    uploadedFrames = []; 
                }
            } else {
                uploadedFrames = [];
            }
            
            selectedFrameId = localStorage.getItem('selectedFrameId');
            if (selectedFrameId && !uploadedFrames.find(f => String(f.id) === selectedFrameId)) {
                selectedFrameId = null; 
            }
            if (uploadedFrames.length > 0 && selectedFrameId === null) {
                selectedFrameId = uploadedFrames[0].id;
            }
        }

        function saveFrames() {
            localStorage.setItem('customFrames', JSON.stringify(uploadedFrames));
            localStorage.setItem('selectedFrameId', selectedFrameId);
            renderStartFrameGallery(); 
            renderFrameOptions();
        }

        function removeFrame(id) {
            uploadedFrames = uploadedFrames.filter(frame => String(frame.id) !== String(id));
            if (String(selectedFrameId) === String(id)) {
                selectedFrameId = uploadedFrames.length > 0 ? uploadedFrames[0].id : null;
            }
            saveFrames();
            if (document.getElementById('step-edit').style.display === 'block') {
                updatePreview('preview-canvas-edit');
            }
        }
        
        // 1ë‹¨ê³„ í”„ë ˆì„ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
        function renderStartFrameGallery() {
            const galleryEl = document.getElementById('start-frame-gallery');
            if (!galleryEl) return;
    
            // 1. ë“±ë¡ëœ í”„ë ˆì„ë“¤ ë Œë”ë§
            let htmlContent = uploadedFrames.map(frame => {
                const fileName = frame.name.split('/').pop().replace(/\.png|\.jpg/i, '');
                return `
                <div class="start-frame-item ${String(selectedFrameId) === String(frame.id) ? 'selected' : ''}" 
                     data-frame-id="${frame.id}"
                    onclick="selectStartFrame('${frame.id}')">
                   <img src="${frame.dataUrl}" alt="${fileName}">
                   <button class="remove-btn" onclick="event.stopPropagation(); removeFrame('${frame.id}')">X</button>
                   <div class="frame-name">${fileName}</div>
               </div>
               `;
            }).join('');

            // 2. ê°¤ëŸ¬ë¦¬ ë‚´ìš© ì±„ìš°ê¸°
            galleryEl.innerHTML = htmlContent;

            // 3. [í•µì‹¬] ì—…ë¡œë“œ ë²„íŠ¼ì„ ê°¤ëŸ¬ë¦¬ ë¦¬ìŠ¤íŠ¸ ë°”ë¡œ ë’¤ì— ë¶™ì„
            const addBtnLabel = document.getElementById('add-btn-label');
            galleryEl.appendChild(addBtnLabel); 
    
            // ì´¬ì˜ ë²„íŠ¼ í™œì„±í™” ë¡œì§ ìœ ì§€
            const startShootBtn = document.getElementById('start-shoot-btn');
            if (startShootBtn) {
                startShootBtn.disabled = !selectedFrameId;
                startShootBtn.style.backgroundColor = selectedFrameId ? '#ff6b81' : '#666666';
            }
        }
        
        // 1ë‹¨ê³„ì—ì„œ í”„ë ˆì„ ì„ íƒ
        function selectStartFrame(id) {
            selectedFrameId = id;
            saveFrames(); 
        }

        // ------------------------------------
        // ğŸŸ¢ [ìµœì¢… êµì²´] í”„ë ˆì„ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (ì§„ë‹¨ ë° ì•ˆì •í™” ë¡œì§)
        // ------------------------------------
        document.getElementById('frame-upload').addEventListener('change', function(e) {
            
            
            const files = e.target.files;
            
            // 1. íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°, íŒŒì¼ ì„ íƒ ì°½ì„ ì´ˆê¸°í™”í•˜ê³  ì¢…ë£Œ
            if (files.length === 0) {
                e.target.value = ''; 
                return;
            }
            
            // 2. íŒŒì¼ì´ ìˆëŠ” ê²½ìš°, íŒŒì¼ ì²˜ë¦¬ ì‹œì‘
            const filePromises = Array.from(files)
                .map(file => {
                    return new Promise(resolve => {
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            if (event.target.result && (file.type.startsWith('image/') || file.name.match(/\.(png|jpe?g)$/i))) {
                                resolve({
                                    id: String(Date.now() + Math.random()), 
                                    name: file.name,
                                    dataUrl: event.target.result
                                });
                            } else {
                                resolve(null); 
                            }
                        }
                        
                        reader.onerror = function() {
                            alert(`[ì˜¤ë¥˜ ë°œìƒ] ${file.name} íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                            resolve(null); 
                        }
                        
                        reader.readAsDataURL(file);
                    });
                });

            // 3. ëª¨ë“  íŒŒì¼ ì½ê¸° ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
            Promise.all(filePromises)
                .then(newFrames => {
                    const validFrames = newFrames.filter(f => f !== null);
                    
                    if (validFrames.length > 0) {

                        uploadedFrames.push(...validFrames);
                        selectedFrameId = validFrames[validFrames.length - 1].id; 
                        
                        saveFrames();
                    } else {
                        alert("[ì‹¤íŒ¨] íŒŒì¼ì„ ì„ íƒí–ˆì§€ë§Œ ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ 0ê°œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(error => {
                    alert("í”„ë ˆì„ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                })
                .finally(() => {
                    // 4. ëª¨ë“  ì²˜ë¦¬ê°€ ëë‚œ í›„, ì…ë ¥ ìš”ì†Œì˜ ê°’ì„ ì´ˆê¸°í™” (ì—°ì† ì—…ë¡œë“œë¥¼ ìœ„í•´ í•„ìˆ˜)
                    e.target.value = ''; 
                });
        });
        // ------------------------------------

        // --- 2ë‹¨ê³„: ì¹´ë©”ë¼ ì´¬ì˜ ë¡œì§ (ê°€ì¥ ì•ˆì •ì ì¸ ì½”ë“œë¡œ ë³µêµ¬ ë° ìˆ˜ì •) ---
        async function startCamera() {
            if (!selectedFrameId) {
                alert("ì‚¬ìš©í•  í”„ë ˆì„ì„ ë¨¼ì € ë“±ë¡í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }

            // ì¹´ë©”ë¼ í™”ë©´ í™œì„±í™”
            document.getElementById('step-start').style.display = 'none';
            document.getElementById('main-content-container').style.display = 'none'; 
            document.getElementById('video-container').style.display = 'block';
            
            // ì»¨íŠ¸ë¡¤/ë©”ì‹œì§€ í‘œì‹œ
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('shoot-btn').style.display = 'block';
            document.getElementById('shoot-msg').style.display = 'block';

            // ì´¬ì˜ ì‹œì‘ ì‹œ ì œëª© ìˆ¨ê¸°ê¸°
            document.getElementById('app-title').style.display = 'none';

            // ì¹´ë©”ë¼ ì‚¬ìš© ê¶Œí•œ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ ì„¤ì •
            try {
                // ğŸ”´ [ìˆ˜ì •] ê³ í™”ì§ˆ ìŠ¤íŠ¸ë¦¼ì„ ìš”ì²­í•˜ëŠ” ì œì•½ ì¡°ê±´ ì¶”ê°€ (Full HDê¸‰)
                const constraints = { 
                    video: {
                        // ìµœì†Œ í•´ìƒë„ ìš”ì²­ (iPad/ì•„ì´í°ì—ì„œ ì•ˆì •ì ì¸ Full HDê¸‰: 1920x1440 ë¹„ìœ¨)
                        width: { ideal: 1920 },
                        height: { ideal: 1440 }
                    }, 
                    audio: false 
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoStream = stream;
                video.srcObject = stream;
                
                // ë¹„ë””ì˜¤ ì¤€ë¹„ ì™„ë£Œ ì‹œ ì¬ìƒ
                video.onloadedmetadata = () => {
                    video.play();
                };

                // ì´¬ì˜ ë²„íŠ¼ì— ì‹œí€€ìŠ¤ ì—°ê²°
                document.getElementById('shoot-btn').onclick = startShootingSequence;
                
            } catch (err) {
                console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ", err);
                alert("ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤! (" + err + ")");
                
                // ì˜¤ë¥˜ ì‹œ ì›ìƒ ë³µêµ¬
                document.getElementById('video-container').style.display = 'none';
                document.getElementById('step-start').style.display = 'flex';
                document.getElementById('app-title').style.display = 'block';
            }
        }

        async function startShootingSequence() {
            // ì´¬ì˜ ì‹œì‘ ì‹œ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('shoot-msg').style.display = 'none'; 
            
            document.getElementById('shoot-btn').style.display = 'none';
            const timerEl = document.getElementById('timer');
            const shotCountEl = document.getElementById('shot-count');
            timerEl.style.display = 'block';
            shotCountEl.style.display = 'block';
            photos.length = 0;
            selectedIndices.length = 0;

            // ì²« ë²ˆì§¸ ì‚¬ì§„ ë”œë ˆì´ í•´ê²°ì„ ìœ„í•œ ì‚¬ì „ ì¤€ë¹„ (Pre-warming)
            preWarmCapture(); 
    
            for (let i = 1; i <= 6; i++) {
                currentShot = i;
                shotCountEl.innerText = `${currentShot} / 6`;

               // ì¹´ìš´íŠ¸ë‹¤ìš´ (íƒ€ì´ë¨¸)
               for (let c = 1; c > 0; c--) {
            timerEl.innerText = c;
                   await new Promise(r => setTimeout(r, 1000));
               }
        
               timerEl.innerText = "ğŸ“¸";
               flashEffect();
        
               // ğŸŒŸ [í•µì‹¬ ìˆ˜ì •] 50ms ëŒ€ê¸°: ë¸Œë¼ìš°ì €ê°€ í°ìƒ‰ í”Œë˜ì‹œë¥¼ í™”ë©´ì— ê·¸ë¦´ ì‹œê°„ì„ í™•ë³´
               await new Promise(r => setTimeout(r, 50)); 
        
              capturePhoto();
        
              // ì‚¬ì§„ ê°„ ê°„ê²© (ì´ 550ms ëŒ€ê¸°)
              await new Promise(r => setTimeout(r, 500)); 
           }

            timerEl.style.display = 'none';
            shotCountEl.style.display = 'none';
            stopCamera();
            showGallery();
        }

        // ğŸŸ¢ [í•µì‹¬ ìˆ˜ì •] í”Œë˜ì‹œ íš¨ê³¼ê°€ ë¹„ë””ì˜¤ ìœ„ì— í™•ì‹¤íˆ ë‚˜íƒ€ë‚˜ë„ë¡ #video-container ë‚´ë¶€ì— ì¶”ê°€
        function flashEffect() {
          const videoContainer = document.getElementById('video-container');
           if (!videoContainer) return; // ì•ˆì „ ì¥ì¹˜

          const div = document.createElement('div');
    
          // ğŸš¨ [ìˆ˜ì •] positionì„ 'fixed'ì—ì„œ ë¶€ëª¨(#video-container)ì— ë§ì¶° 'absolute'ë¡œ ë³€ê²½
          div.style.position = 'absolute'; 
    
          // ë¶€ëª¨ ì „ì²´ë¥¼ ë®ë„ë¡ ì„¤ì •
          div.style.top = '0'; 
          div.style.left = '0';
          div.style.width = '100%'; 
          div.style.height = '100%';
    
          div.style.background = 'white';
          div.style.opacity = '1';
    
          // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ(99)ë³´ë‹¤ ë†’ì€ z-index ì„¤ì •
          div.style.zIndex = '999'; 
    
          // ğŸŒŸ [í•µì‹¬ ìˆ˜ì •] #video-containerì˜ ìì‹ìœ¼ë¡œ ì¶”ê°€
          videoContainer.appendChild(div); 
    
          // 50ms í›„ ì œê±°
         setTimeout(() => div.remove(), 40);
        }

        // --- 3-2ë‹¨ê³„: í•œ ì»· ì´¬ì˜ í•¨ìˆ˜ (ê³ í™”ì§ˆ í¬ë¡­ ë¡œì§ ì ìš©) ---
        function capturePhoto() {
            // 1. ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„± ë° ë¹„ë””ì˜¤ í•´ìƒë„ ì„¤ì • (ì›ë³¸ í”„ë ˆì„ ìº¡ì²˜ìš©)
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;

            tempCanvas.width = videoWidth;
            tempCanvas.height = videoHeight;

            // ì¢Œìš° ë°˜ì „
            tempCtx.translate(videoWidth, 0);
            tempCtx.scale(-1, 1);
            tempCtx.drawImage(video, 0, 0, videoWidth, videoHeight);

           // --- ğŸŸ¢ [í•µì‹¬ ìˆ˜ì •] ìµœì¢… í•©ì„± ì‹œ í™•ëŒ€ê°€ ì¼ì–´ë‚˜ì§€ ì•Šë„ë¡ í•´ìƒë„ ìƒí–¥ ì¡°ì • ---

           // 2. ìµœì¢… ë„¤ì»·ì˜ í•œ ì»· ëª©í‘œ í¬ê¸°: 1350px X 1800px (3:4 ë¹„ìœ¨)
           //    -> ìµœì¢… í•©ì„± ìº”ë²„ìŠ¤ì—ì„œ í•œ ì»·ì˜ í¬ê¸°(1350x1800)ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ì—¬ í™•ëŒ€ ë°©ì§€
           const targetWidth = 1350; // â¬…ï¸ ìˆ˜ì •: 450 -> 1350
            const targetHeight = 1800; // â¬…ï¸ ìˆ˜ì •: 600 -> 1800
            const targetRatio = targetWidth / targetHeight; // 0.75

         // 3. ìµœì¢… ì¶œë ¥ìš© ìº”ë²„ìŠ¤ ìƒì„± ë° í¬ê¸° ì„¤ì •
          const finalPhotoCanvas = document.createElement('canvas');
          const finalPhotoCtx = finalPhotoCanvas.getContext('2d');
          finalPhotoCanvas.width = targetWidth;
          finalPhotoCanvas.height = targetHeight;

          // 4. ìº”ë²„ìŠ¤ì˜ ëª©í‘œ ë¹„ìœ¨(3:4)ì— ë§ì¶”ê¸° ìœ„í•´ ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ ì˜ë¼ë‚¼ ì˜ì—­ ê³„ì‚°
          const sourceRatio = videoWidth / videoHeight;

          let sourceX, sourceY, sourceWidth, sourceHeight;

          if (sourceRatio > targetRatio) {
          // ì›ë³¸ì´ ëª©í‘œë³´ë‹¤ ê°€ë¡œê°€ ê¸´ ê²½ìš° (ì„¸ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ê³  ê°€ë¡œë¥¼ í¬ë¡­)
              sourceHeight = videoHeight;
               sourceWidth = videoHeight * targetRatio; 
               sourceX = (videoWidth - sourceWidth) / 2; // ê°€ë¡œ ì¤‘ì•™
               sourceY = 0;
           } else {
              // ì›ë³¸ì´ ëª©í‘œë³´ë‹¤ ì„¸ë¡œê°€ ê¸´ ê²½ìš° (ê°€ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ê³  ì„¸ë¡œë¥¼ í¬ë¡­)
              sourceWidth = videoWidth;
              sourceHeight = videoWidth / targetRatio; 
              sourceX = 0;
              sourceY = (videoHeight - sourceHeight) / 2; // ì„¸ë¡œ ì¤‘ì•™
          }

           // 5. ì›ë³¸(tempCanvas)ì—ì„œ ê³„ì‚°ëœ ì˜ì—­ì„ ì˜ë¼ë‚´ì–´ ìµœì¢… ìº”ë²„ìŠ¤(finalPhotoCanvas)ì— ì¶•ì†Œí•˜ì—¬ ê·¸ë¦¬ê¸°
           finalPhotoCtx.drawImage(
               tempCanvas, 
               sourceX,    
               sourceY,    
               sourceWidth,  
               sourceHeight, 
               0, 0,       
               targetWidth,  
               targetHeight  
           );

           // 6. ìµœì¢…ì ìœ¼ë¡œ í¬ë¡­ ë° ìº¡ì²˜ëœ ê³ í™”ì§ˆ dataURL ì €ì¥ (PNG ë¬´ì†ì‹¤ ì••ì¶•ìœ¼ë¡œ ë³€ê²½)
            photos.push(finalPhotoCanvas.toDataURL('image/png')); // â¬…ï¸ ìˆ˜ì •: 'image/jpeg', 0.95 -> 'image/png'
        }              

        // [ì¶”ê°€] ì²« ë²ˆì§¸ ì‚¬ì§„ì˜ ë”œë ˆì´ë¥¼ ì¤„ì´ê¸° ìœ„í•œ ì‚¬ì „ ì¤€ë¹„ í•¨ìˆ˜
        function preWarmCapture() {
            const canvas = document.createElement('canvas');
            if (video.videoWidth === 0 || video.videoHeight === 0) return; 
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            
            try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toDataURL('image/png'); 
            } catch (e) {
                // ë¬´ì‹œ
            }
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('video-container').style.display = 'none';
            
            // ì´¬ì˜ ì¢…ë£Œ ì‹œ ì œëª© ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('app-title').style.display = 'block';
        }

        function showGallery() {
            goToSelectStep(); // ê°¤ëŸ¬ë¦¬/ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            photos.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.onclick = () => toggleSelection(index, div);
                div.innerHTML = `<img src="${src}"><div class="badge"></div>`;
                gallery.appendChild(div);
            });
            updateSelectionStatus(); 
            updatePreview('preview-canvas'); 
            updateBadges(); 
        }

        // ------------------------------------

        // --- 3ë‹¨ê³„: ì‚¬ì§„ ì„ íƒ ë¡œì§ ---
        function toggleSelection(index, element) {
            const idxInSelected = selectedIndices.indexOf(index);
            const nextBtn = document.getElementById('next-to-edit-btn'); 
            
            if (idxInSelected > -1) {
                selectedIndices.splice(idxInSelected, 1);
            } else {
                if (selectedIndices.length < 4) {
                    selectedIndices.push(index);
                } else {
                    alert('4ì¥ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            }

            updateBadges(); 
            updateSelectionStatus();
            updatePreview('preview-canvas'); 
            
            // ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœì™€ ìƒ‰ìƒ(í´ë˜ìŠ¤) ì—…ë°ì´íŠ¸
            const isFourSelected = (selectedIndices.length === 4);
            
            nextBtn.disabled = !isFourSelected; 
            
            if (isFourSelected) {
                nextBtn.classList.add('active'); 
            } else {
                nextBtn.classList.remove('active'); 
            }
        }

        function updateBadges() {
            const gallery = document.getElementById('gallery');
            const items = gallery.querySelectorAll('.photo-item');
            
            items.forEach((item, index) => {
                const badge = item.querySelector('.badge');
                const photoIndex = selectedIndices.indexOf(index);
                
                item.classList.remove('selected');
                badge.style.display = 'none';

                if (photoIndex > -1) {
                    item.classList.add('selected');
                    badge.innerText = photoIndex + 1;
                    badge.style.display = 'flex';
                } 
            });
        }
        
        function updateSelectionStatus() {
            const count = selectedIndices.length;
            document.getElementById('selection-status-text').innerText = `ğŸ“¸ ì‚¬ì§„ ì„ íƒ (${count}/4)`;
        }
        
        // ------------------------------------

        // --- 4ë‹¨ê³„: í”„ë ˆì„ ì„ íƒ ë° í•©ì„± ë¡œì§ ---
        function renderFrameOptions() {
            const container = document.getElementById('frame-options-list');
            container.innerHTML = '';
            
            if (uploadedFrames.length === 0) {
                container.innerHTML = `<p style="color: #ff4757; padding: 10px;">ì—…ë¡œë“œëœ í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤. ì‹œì‘ í™”ë©´ì—ì„œ í”„ë ˆì„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</p>`;
                return;
            }

            uploadedFrames.forEach(frame => {
                const div = document.createElement('div');
                div.setAttribute('data-frame-id', frame.id); 
                div.className = `frame-option ${String(selectedFrameId) === String(frame.id) ? 'selected' : ''}`; 
                div.onclick = () => selectFrame(frame.id);
                
                div.style.backgroundImage = `url(${frame.dataUrl})`;
                container.appendChild(div);
            });
        }

        function selectFrame(id) {
            selectedFrameId = id;
            localStorage.setItem('selectedFrameId', id); 
            
            const options = document.querySelectorAll('#frame-options-list .frame-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (String(option.getAttribute('data-frame-id')) === String(id)) {
                    option.classList.add('selected');
                }
            });

            updatePreview('preview-canvas-edit'); 
        }

        function loadPhoto(photoDataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = photoDataUrl;
            });
        }

       async function drawComposite(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // ğŸŸ¢ [ìˆ˜ì •] ìƒˆë¡œìš´ ìµœì¢… ìº”ë²„ìŠ¤ í•´ìƒë„ ì ìš©
            const width = 3000; 
            const height = 4440;
            canvas.width = width;
            canvas.height = height;

            // ğŸŸ¢ [ìˆ˜ì •] ì‚¬ì§„ í¬ê¸°: 45mm x 60mm -> 1350px x 1800px
            const photoWidth = 1350; 
            const photoHeight = 1800; 

            // ğŸŸ¢ [ìˆ˜ì •] ìƒˆë¡œìš´ ìœ„ì¹˜ ì¢Œí‘œ (30px/mm ìŠ¤ì¼€ì¼ ì ìš©)
            const positions = [
                {x: 120, y: 600},   // 1ë²ˆ: 4mm / 20mm -> 120 / 600
                {x: 1560, y: 600},  // 2ë²ˆ: 52mm / 20mm -> 1560 / 600
                {x: 120, y: 2520},  // 3ë²ˆ: 4mm / 84mm -> 120 / 2520
                {x: 1560, y: 2520}  // 4ë²ˆ: 52mm / 84mm -> 1560 / 2520
            ];
            
            const loadingPromises = selectedIndices.map(index => loadPhoto(photos[index]));
            const loadedImages = await Promise.all(loadingPromises);

            // 1. ë°°ê²½ í°ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸°
            ctx.fillStyle = 'white'; 
            ctx.fillRect(0, 0, width, height);

            // 2. ì‚¬ì§„ ê·¸ë¦¬ê¸° (ì„ íƒëœ ì‚¬ì§„ ìˆ˜ë§Œí¼)
            loadedImages.forEach((img, i) => {
                if (positions[i]) {
                    const targetX = positions[i].x;
                    const targetY = positions[i].y;
                    
                    // ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬ ë° ì±„ìš°ê¸° ë¡œì§ (Cover)
                    const imgAspectRatio = img.width / img.height;
                    const containerAspectRatio = photoWidth / photoHeight;
                    
                    let drawWidth, drawHeight, offsetX, offsetY;

                    if (imgAspectRatio > containerAspectRatio) {
                        // ... (ì´ì „ ë¡œì§ ìœ ì§€ - ì‚¬ì§„ì„ ì„¸ë¡œì— ë§ì¶”ê³  ê°€ë¡œë¥¼ ëŠ˜ë¦¼) ...
                        drawHeight = photoHeight;
                        drawWidth = photoHeight * imgAspectRatio;
                        offsetX = targetX - (drawWidth - photoWidth) / 2;
                        offsetY = targetY;
                    } else {
                        // ... (ì´ì „ ë¡œì§ ìœ ì§€ - ì‚¬ì§„ì„ ê°€ë¡œì— ë§ì¶”ê³  ì„¸ë¡œë¥¼ ëŠ˜ë¦¼) ...
                        drawWidth = photoWidth;
                        drawHeight = photoWidth / imgAspectRatio;
                        offsetX = targetX;
                        offsetY = targetY - (drawHeight - photoHeight) / 2;
                    }
                    
                    // ---------------------------------------------------------------------
                    // ğŸŸ¢ [ì¶”ê°€] 1.2ë°° ì¤Œ íš¨ê³¼ ì ìš© ì‹œì‘ 
                    const zoomFactor = 1.2;

                    // 1. ì´ë¯¸ì§€ í¬ê¸°ë¥¼ 1.2ë°° í™•ëŒ€
                    drawWidth *= zoomFactor;
                    drawHeight *= zoomFactor;

                    // 2. í™•ëŒ€ëœ ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ë‹¤ì‹œ ë°°ì¹˜ (offsetX, offsetY ì¡°ì •)
                    // í™•ëŒ€ ì¤‘ì‹¬ì„ (photoWidth/2, photoHeight/2)ë¡œ ìœ ì§€
                    offsetX = targetX - (drawWidth - photoWidth) / 2;
                    offsetY = targetY - (drawHeight - photoHeight) / 2;
                    // ğŸŸ¢ [ì¶”ê°€] 1.2ë°° ì¤Œ íš¨ê³¼ ì ìš© ë
                    // ---------------------------------------------------------------------
                    
                    // ğŸŸ¢ [í•µì‹¬ ìˆ˜ì •] 4í”½ì…€ì˜ ì˜¤ë²„í•„ ë§ˆì§„ì„ ì¶”ê°€í•˜ì—¬ ë¹ˆí‹ˆì„ ë°©ì§€í•©ë‹ˆë‹¤.
                    const overfillMargin = 4;
                    const offsetCorrection = overfillMargin / 2; // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ 2í”½ì…€ ì´ë™

                    drawWidth += overfillMargin;
                    drawHeight += overfillMargin;
                    offsetX -= offsetCorrection;
                    offsetY -= offsetCorrection;
                    // ---------------------------------------------------------------------

                    // ì‚¬ì§„ì„ ì›í•˜ëŠ” ì˜ì—­ë§Œ ë³´ì´ë„ë¡ í´ë¦¬í•‘ ì²˜ë¦¬ (ì´ì „ì— ì •ì˜í•œ ì •í™•í•œ í¬ê¸°)
                    ctx.save();
                    ctx.beginPath();
                    // ì´ rect ì˜ì—­ì´ ì‚¬ì§„ì˜ ì •í™•í•œ ê²½ê³„ê°€ ë©ë‹ˆë‹¤.
                    ctx.rect(targetX, targetY, photoWidth, photoHeight); 
                    ctx.clip();
                    
                    // ì˜ë„ì ìœ¼ë¡œ í¬ê²Œ ê³„ì‚°ëœ í¬ê¸°ë¡œ ì´ë¯¸ì§€ë¥¼ ê·¸ë ¤ í´ë¦¬í•‘ ì˜ì—­ì„ ì™„ì „íˆ ì±„ì›ë‹ˆë‹¤.
                    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    
                    ctx.restore();
                }
            });

            // 3. 3ë‹¨ê³„ í”„ë¦¬ë·° ì²˜ë¦¬ (í”„ë ˆì„ ë¯¸ì ìš©, ë¹ˆì¹¸ ì²˜ë¦¬)
            if (canvasId === 'preview-canvas') {
                // ì„ íƒë˜ì§€ ì•Šì€ ì¹¸ì„ íšŒìƒ‰ìœ¼ë¡œ ì±„ìš°ëŠ” ë¡œì§
                ctx.fillStyle = '#6c757d'; 
                
                // ì„ íƒëœ ì‚¬ì§„ ë‹¤ìŒ ìˆœì„œ(loadedImages.length)ë¶€í„° 4ë²ˆì§¸ ì¹¸(ì¸ë±ìŠ¤ 3)ê¹Œì§€ ë°˜ë³µ
                for(let i = loadedImages.length; i < 4; i++) {
                    const pos = positions[i];
                    ctx.fillRect(pos.x, pos.y, photoWidth, photoHeight);
                }
                
                // ê¸°ë³¸ í…ìŠ¤íŠ¸ ë° í…Œë‘ë¦¬
                const frameGapY_top = 600; // ğŸŸ¢ [ìˆ˜ì •] 20mm ì‹œì‘ì 
                ctx.fillStyle = 'black';
                ctx.font = 'bold 120px Pretendard, sans-serif'; // ğŸŸ¢ [ìˆ˜ì •] ê¸€ê¼´ í¬ê¸° ì¡°ì •
                ctx.textAlign = 'center';
                // ğŸŸ¢ [ìˆ˜ì •] í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì •
                ctx.fillText("MY PHOTO BOOTH", width/2, frameGapY_top / 2 + 30); 
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 10; // ğŸŸ¢ [ìˆ˜ì •] í…Œë‘ë¦¬ ë‘ê»˜ ì¡°ì •
                ctx.strokeRect(0,0, width, height);
            } 
            // 4. í¸ì§‘/ìµœì¢… ë‹¨ê³„: ì„ íƒëœ ì»¤ìŠ¤í…€ í”„ë ˆì„ ì ìš©
            else if (selectedFrameId) {
                const currentFrame = uploadedFrames.find(f => String(f.id) === String(selectedFrameId)); 
                if (currentFrame) {
                    const frameImg = await loadPhoto(currentFrame.dataUrl);
                    
                    // ğŸŸ¢ [ìˆ˜ì •] í•˜ë‹¨ í‹ˆì„ í™•ì‹¤íˆ ë®ê¸° ìœ„í•´ ë†’ì´ì— 1pxì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                    ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
                }
            }
        }

        // --- ğŸŸ¢ [ìƒˆ í•¨ìˆ˜] iOS Web Share APIë¥¼ ì‚¬ìš©í•´ ê³µìœ  ì‹œíŠ¸ ì§ì ‘ í˜¸ì¶œ ---
        // ì´ í•¨ìˆ˜ëŠ” ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ iOS ê³µìœ  ì‹œíŠ¸ (Messages, AirDrop ë“±)ë¥¼ ë„ì›ë‹ˆë‹¤.
        // ğŸš¨ ì£¼ì˜: ì´ ê¸°ëŠ¥ì€ HTTPS í™˜ê²½(ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸)ì—ì„œë§Œ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.
async function downloadAndShare() {
    if (!finalImageDataURL) {
        alert("ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return;
    }
    
    if (navigator.share) {
        try {
            const response = await fetch(finalImageDataURL);
            const blob = await response.blob();
            const file = new File([blob], "InsaengNekot.png", { type: 'image/png' });

            await navigator.share({
                title: 'ë‚˜ë§Œì˜ ì¸ìƒë„¤ì»· ì™„ì„±!',
                text: shareMessage, // ğŸŸ¢ [ìˆ˜ì •] ê°•ì œëœ ë¬¸êµ¬ ëŒ€ì‹  shareMessage ë³€ìˆ˜ ì‚¬ìš©
                files: [file],
            });
            console.log('ê³µìœ  ì„±ê³µ');
        } catch (error) {
            if (error.name !== 'AbortError') {
                alert(`âŒ ê³µìœ  ì‹œíŠ¸ í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
            }
        }
    } else {
        alert("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ë²„íŠ¼ì„ í†µí•œ ì§ì ‘ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

        async function updatePreview(canvasId) {
            await drawComposite(canvasId); 
        }
    </script>
</body>
</html>